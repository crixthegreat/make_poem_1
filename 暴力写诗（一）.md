

### 暴力写诗（NLP 自学笔记）（一）收集大数据



​		用机器写诗，如今已不是难事。在过去，琴棋书画与诗都是高大上的东西，可是现在，这几样机器已经全都玩转啦。水平如何且不说，至少象模像样肯定没问题。而且机器还有一个压倒性的优势——速度快。

​		少年，想象一下一分钟写一万首五言古诗那种酸爽！

​		接下来，我们就来探讨一下怎么用机器来写诗。事先说明一下，我对机器写诗**毫无经验**，因此，所谓的探讨，只不过是我自己学习过程的一个记录而已。会看我这些罗嗦话的，也许是对我这些文字感兴趣的人，或是想学用机器来写诗的人，或是那些纯粹想分分钟写十首八首藏头情诗骗MM的人，如果对大家有所益处，那也算是一件美事。

​		（严肃脸）认真点说，机器写诗，就是自然语言处理（NLP）的一个应用场景。本系列文字实际上也就是 NLP 的自学过程。



​		OK，言归正传，开始学习让机器写诗。

​		首先，让我们设定一个小小的目标。我们的目标是：

1. 用电脑写出一首**五言绝句**（五言绝句从形式上应该是最简单的古诗了）

2. 写出来的这首诗不与现存的任何一首古诗相同（抄袭太丢人了）

3. 将这首诗和另外四首古人写的诗放在一起，你将无法分辨哪一首是电脑写的（要求很高！这可是很厉害的测试）



​		目标设定好了，怎么入手呢？我的耳边响起了一句老话，“前事不忘，后事之师”！听到没，前“诗”不忘，后“世”之“诗”。

​		那么，首先让我们收集一下古人写的诗。如果我们要找集所有古人写的诗，这项工作，你猜应该找谁呢？答案绝不是诗歌文学爱好者，而是程序员！

​		于是我们来到了全球最大的同性交友网站，程序员的家园 Github。在这里，我们找到了两个大名鼎鼎的项目：

 1. [chinese-poetry](https://github.com/chinese-poetry)/**[chinese-poetry](https://github.com/chinese-poetry/chinese-poetry)** 

    这个伟大的项目收集了海量的中国古诗词，且不说词，单论诗歌，体量就能让人大吃一惊！

    确切的说，这个项目收集了唐代古诗 57000 首，宋代古诗一共 254000 首，合计**三十一万**首诗！不由得让人感慨一声 —— 古人真 TM 闲呐！

 2. [Provinm / chinese-poetry-simplified](https://github.com/Provinm/chinese-poetry-simplified)

    这个项目为上面的项目做了一点小而关键的贡献，那就是将繁体字转化为了简体字，并且将输出的结果也保存了。于是我将他的成果直接拖进了自己的电脑。

    

 		拖好以后，电脑里就多了这么些宝贝（下图只是一部分）。这可是名副其实的宝贝啊，都是古人智（无）慧（聊）的结（产）晶（物）！纯文本文件合计达到 200 M之巨。

​		![1574056205413](D:\myfiles\poem\1.png)

​		对着这三十多万首诗，我兴奋的差点睡不着觉！而当我打开任意一个文件，看到这美妙的格式，直接从床上蹦了下来 —— JSON 格式。这相当于什么呢，这相当于一个人不仅帮你抄了30多万首诗，而且还是帮你一张纸一首，格式一致，抄的工工整整！
​    

```json
[
    {
        "author": "范仲淹",
        "paragraphs": [
            "数枝梅寄寂寥人，多谢韶华次第均。",
            "穰下此花留未发，待君同赏后池春。"
        ],
        "strains": [
            "仄平平仄仄平平，平仄平平仄仄平。",
            "仄仄仄平平仄仄，仄平平仄仄平平。"
        ],
        "title": "依韵和提刑张太傅寄梅"
    },
    {
        "author": "范仲淹",
        "paragraphs": [
            "故人为使富天才，相与抽毫赋早梅。",
            "气艷未劳横玉笛，风光先合倒金罍。",
            "陇头欲寄交情远，林下初逢病眼开。",
            "必若和羮有遗味，花王应亦命公台。"
        ],
        "strains": [
            "仄平平仄仄平平，仄仄平平仄仄平。",
            "仄仄仄平平仄仄，平平平仄仄平平。",
            "仄平仄仄平平仄，平仄平平仄仄平。",
            "仄仄平平仄仄仄，平平仄仄仄平平。"
        ],
        "title": "又和赏梅"
    },
    {
        "author": "范仲淹",
        "paragraphs": [
            "芳洲名冠古南都，最惜尘埃一点无。",
            "楼阁春深来海鷰，池塘人静下仙鳬。",
            "花情柳意凭谁问，月彩波光岂易图。",
            "汉上山公发新咏，许昌何必诧申湖。"
        ],
        "strains": [
            "平平平仄仄平平，仄仄平平仄仄平。",
            "平仄平平平仄仄，平平平仄仄平平。",
            "平平仄仄平平仄，仄仄平平仄仄平。",
            "仄仄平平仄平仄，仄平平仄仄平平。"
        ],
        "title": "依韵答王源叔忆百花洲见寄"
    },
```

​	

​		接下来，先来一个小处理吧，30多万首并不完全是我们想要的，为了让事情变得再简单一些，我们筛选一下，把其中的五言诗留下来。




```python
import os
import json

def file_analyse(file_name, out):
    with open(file_name, 'r', encoding='utf-8-sig') as f:
        data = json.loads(f.read())
    for _poem in data:
        if _poem['paragraphs']:
            # 对于是否是五言诗处理非常简单粗暴
            # 如果第一句加上逗号和句号一共是 12 个字
            # 那就是五言诗
​            if len(_poem['paragraphs'][0])==12:
​                out.append(_poem)
​    return None

pathname = './poem-data/'
out_list = []

for parent,dirnames,filenames in os.walk(pathname):
    for file_name in filenames:
        #print('now parsing file', file_name)
        file_analyse(pathname + file_name, out_list)
    
json_data = json.dumps(out_list, indent=4, ensure_ascii=False)
with open('five.json', 'w', encoding='utf-8-sig') as f:
    f.write(json_data)
```



​		运行上面的代码，我们留下了所有的五言诗，并存在 five.json 这个巨型文件中。这个文件有近 100M 那么大，一共包含了 **118722** 首五言诗。打开欣赏一下：

​		

```json
[
    {
        "author": "幸夤逊",
        "paragraphs": [
            "巧剪银花乱，轻飞玉叶狂。"
        ],
        "strains": [
            "仄仄平平仄，○平仄仄平。"
        ],
        "title": "句  其七"
    },
    {
        "author": "释志端",
        "paragraphs": [
            "来年二月二，与汝暂相弃。",
            "烧灰散长江，勿占檀那地。"
        ],
        "strains": [
            "平平仄仄仄，仄仄仄平仄。",
            "仄平仄平平，仄平平仄仄。"
        ],
        "tags": [
            "长江"
        ],
        "title": "偈"
    },
```



​		非常完美。前期工作就做到这个程度。接下来，我们终于终于，可以开始尝试动手写诗啦！


