### 暴力写诗（五）（平仄）



​	一首五言诗，据说关于平仄有一个基本上成立的规律，那就是：“一三不论，二四分明“。意思是：对于一句诗中的第一个字和第三个字，平仄可以不论。但是第二个字和第四个字，一定是上下两句相对的。

​	例如：

```
白日依山尽
黄河入海流
```

​	其中每句的第二个字”日“和”河“、第四个字”山“和”海“的平仄是相对的。

​	因此，我们可以利用手上的几十万句诗，来将所有出现在第二和第四的位置上的字，来一个分组了。



​	这里采用的方法是这样的：

​	**平仄区分的四步**：

1. 【初始化】
    1. 生成字库
    2. 将字库中所有的字，例如  ”人“ ，将其平仄关系记为：

$$
人^{a=50}_{b=50}
$$

​	其中 a 与 b，分别代表这个字是平声和仄声两个系列的概率。对于所有的字，初始概率都是 50 对 50。也就是还不清楚是属于哪一类。

2. 【初始化第一个字】我们拿出一个字，最好是高频字，例如”人“，我们将它”定“为平声字，也就是说，让它：
    $$
    人^{a=100}_{b=0}
    $$
    
3. 【选出参考字】遍历字库中所有的字，选出 a 值与 b 值相差最大的一个字，也就是区分的最好的一个字作为参考字。第一个参考字显然就是前面定出来的“人”字。

4. 【计算刷新每一个字的 ab 值】根据参考字的平仄分类，针对数据样本每一个字对（出现在上下两句的第二个字为一对，出现在上下两句的第四个字也为一对），例如出现一次（人，我），因为”人“是 a 类的，则”我“字的 b 值 + 1，变成：
    $$
    我^{a=49}_{b=51}
    $$
    
5. 标记参考字为”已参考“。重复步骤3，直至所有的字都已被参考过。

​	代码如下：

```python

import sys
import json

with open('couple_words.json', 'r', encoding='utf-8-sig') as f:
    data = json.loads(f.read())

full_data = []
for _ in range(len(data)):
    full_data.append(''.join(data[_]))

full_data = ''.join(full_data)


pingze = {}
not_judged = {}
# 1.【初始化】
#   1-1. 生成字库
#   1-2. 将字库中所有的字，例如  ”人“ ，将其平仄关系记为：50,50
for _ in data:
    if not(_[0] in pingze.keys()):
        pingze[_[0]] = [50, 50, 0]
        not_judged[_[0]] = 1
    if not(_[1] in pingze.keys()):
        pingze[_[1]] = [50, 50, 0]
        not_judged[_[1]] = 1

print('dict initialised')

# 2.【初始化第一个字】人
pingze['人'][0] = 100

for _ in pingze.keys():
    pingze[_][2] = full_data.count(_)

print('words freq counted')

next_word = 1

while next_word:
    next_word = None
    for _ in pingze.keys():
        # 3.【选出参考字】遍历字库中所有的字，
        # 选出 a 值与 b 值相差最大的一个字，
        # 也就是区分的最好的一个字作为参考字。
        if not_judged[_]:
            if next_word:
                if abs(pingze[_][0] - pingze[_][1]) >= abs(pingze[next_word][0] - pingze[next_word][1]):
                    next_word = _
            else:
                next_word = _
    
    if next_word:
        print(next_word, pingze[next_word][0], pingze[next_word][1])
        next_word_pingze = 0
        if pingze[next_word][0] > pingze[next_word][1]:
            # 平
            next_word_pingze = 0
        elif pingze[next_word][0] == pingze[next_word][1]:
            # 不确定
            next_word_pingze = 2
        else:
            # 仄
            next_word_pingze = 1

        # 4.【计算刷新每一个字的 ab 值】
        # 根据参考字的平仄分类，针对数据样本每一个字对
        #（出现在上下两句的第二个字为一对，出现在上下两句的第四个字也为一对）
        # 例如出现一次（人，我），因为'人'是 a 类的，
        # 则'我'字的 b 值 + 1, a 值 - 1
        for _ in data:
            if next_word in _:
                if next_word == _[0]:
                    change_word = _[1]
                else:
                    change_word = _[0]
                if next_word_pingze == 0:
                    pingze[change_word][0] -= 1
                    pingze[change_word][1] += 1
                elif next_word_pingze == 1:
                    pingze[change_word][0] += 1
                    pingze[change_word][1] -= 1

        # 5. 标记参考字为'已参考'。重复步骤3，直至所有的字都已被参考过            
        not_judged[next_word] = 0


with open('pingze.json', 'w', encoding='utf-8-sig') as f:
    f.write(json.dumps(pingze, indent=4, ensure_ascii=False))
```

​	运行后，我们就得到了一个下面这样的大字典：

```
{
    "年": [
        8886,
        -8786,
        12711
    ],
    "汝": [
        -230,
        330,
        1018
    ],
    "月": [
        -6979,
        7079,
        11257
    ],
    "相": [
        1978,
        -1878,
        9986
    ],
    "占": [
        -46,
        146,
        348
    ],
    "灰": [
        165,
        -65,
        228
    ],
    "那": [
        65,
        35,
        93
    ]
    ……
```

​	接下来，我们就可以开始分类了。按照上面字典内的每一个字的计算结果，我们可以计算出它是平是则仄的概率。根据这个概率，我们将所有的字分为 4 类。

1. 平声字： a > b 且概率 > 0.15

2. 仄声字： b > a 且概率 > 0.15

3. 多音字： 概率 < 0.15

4. 不确定： a= b

​	分类代码如下：

```
import json

with open('pingze.json', 'r', encoding='utf-8-sig') as f:
    data = json.loads(f.read())

# [平声字， 仄声字， 多音字， 不确定]
pingze_dict = [{}, {}, {}, {}]

for _ in data.keys():
    prob = abs(data[_][0] - data[_][1]) / 2 / data[_][2]
    if 0 < prob < 0.15:
        pingze_dict[2][_] = prob
        continue

    if data[_][0] > data[_][1]:
        pingze_dict[0][_] = prob
    elif data[_][0] == data[_][1]:
        pingze_dict[3][_] = prob
    else:
        pingze_dict[1][_] = prob


with open('pingze_dict_with_prob.json', 'w', encoding='utf-8-sig') as f:
    f.write(json.dumps(pingze_dict, indent=4, ensure_ascii=False))
```

打开我们的平仄字典看一看：

```
[
    {
        "年": 0.6951459365903548,
        "相": 0.1930702984177849,
        "灰": 0.5043859649122807,
        "那": 0.16129032258064516,
        "长": 0.2573813887192018,
        "将": 0.540269221994068,
        "禅": 0.4222668004012036,
        "间": 0.5736228813559322,
        "千": 0.462883202432227,
        "萝": 0.5856443719412724,
        "生": 0.6454551728897785,
        "声": 0.712506671410781,
        "岚": 0.6159695817490495,
        "鱼": 0.5136221527467619,
        "怜": 0.7893231649189705,
        "王": 0.427115987460815,
```

​	平声字、仄声字都整整齐齐的放在了一起！太棒了。

​	另外，通过这个字典，我还第一次发现：

​	“石”和“白”竟然是**仄声字**（他们明明是第二声）。

​	一开始我还以为算法和数据出了问题。结果一查，这两个字的的确确是仄声。果然，机器不会骗人，而且还会教给我们新的知识！

​	好，现在可以研究五言绝句的平仄格律了。五言绝句的格律有且仅有四种形式：

1.  仄起仄收（即首句仄起不入韵式）如：

```
　　　登鹳雀楼（王之涣）

　　　白日依山尽　　　　　　仄仄平平仄
　　　黄河入海流　　　　　　平平仄仄平　　
　　　欲穷千里目　　　　　　平平平仄仄　
　　　更上一层楼　　　　　　仄仄仄平平 
```

2.  仄起平收（即首句仄起入韵式）如：

    ```
    　　　　塞下曲（卢纶）
    
    　　　林暗草惊风　　　　　仄仄仄平平
    　　　将军夜引弓　　　　　平平仄仄平　　
    　　　平明寻白羽　　　　　平平平仄仄　
    　　　没在石棱中　　　　　仄仄仄平平 
    ```
    
3.  平起仄收（即首句仄起不入韵式）如：

    ```
    　　　夜宿山寺（李白）
    
    　　　危楼高百尺　　　　　平平平仄仄
    　　　手可摘星辰　　　　　仄仄仄平平　　
    　　　不感高声语　　　　　仄仄平平仄　
    　　　恐惊天上人　　　　　平平仄仄平 
    ```

    

4.  平起平收（即首句平起入韵式）如：

    ```
    　　　 听鼓（李商隐）
    
    　　　城头叠骨声　　　　　 平平仄仄平
    　　　城下暮江清　　　　　 仄仄仄平平　　
    　　　欲问渔阳掺　　　　　 仄仄平平仄　
    　　　时无祢正平　　　　　 平平仄仄平 
    ```

​	这四种都是由首句而定的。换句话说，一首五言绝句，只要首句的格律定了，后面的格律都是定死的。

​    那么我们又可以动手写诗了：



好啦，来看看效果：

```
适有重游侠
声非怒雨蛙
朝昏灯已暗
总是趁潮蛤

头僧七月章
吹坐是心光
惊问承之人
肇当岂暇翔

房山寄四圣
乱竹劲枝梢
心念曾吞海
哀歌使郑淆

冰河锁纽牢
此别大春涛
仙髮如鸦墨
山留腹背毛

爻辞幽处宅
及上石盆差
嘉节追胥迹
牵怀染醉腮
```

要说这里面有一首不是机器写的，聪明的你，能挑出是哪一首吗？